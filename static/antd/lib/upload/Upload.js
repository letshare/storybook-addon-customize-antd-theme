"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),React=_interopRequireWildcard(require("react")),_rcUpload=_interopRequireDefault(require("rc-upload")),_useMergedState3=_interopRequireDefault(require("rc-util/lib/hooks/useMergedState")),_classnames=_interopRequireDefault(require("classnames")),_Dragger=_interopRequireDefault(require("./Dragger")),_UploadList=_interopRequireDefault(require("./UploadList")),_utils=require("./utils"),_LocaleReceiver=_interopRequireDefault(require("../locale-provider/LocaleReceiver")),_default2=_interopRequireDefault(require("../locale/default")),_configProvider=require("../config-provider"),_devWarning=_interopRequireDefault(require("../_util/devWarning"));function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof3(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var __awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},LIST_IGNORE="__LIST_IGNORE_".concat(Date.now(),"__"),InternalUpload=function InternalUpload(props,ref){var _classNames2,fileList=props.fileList,defaultFileList=props.defaultFileList,onRemove=props.onRemove,showUploadList=props.showUploadList,listType=props.listType,onPreview=props.onPreview,onDownload=props.onDownload,onChange=props.onChange,onDrop=props.onDrop,previewFile=props.previewFile,disabled=props.disabled,propLocale=props.locale,iconRender=props.iconRender,isImageUrl=props.isImageUrl,progress=props.progress,customizePrefixCls=props.prefixCls,className=props.className,type=props.type,children=props.children,style=props.style,itemRender=props.itemRender,maxCount=props.maxCount,_useMergedState=(0,_useMergedState3.default)(defaultFileList||[],{value:fileList,postState:function postState(list){return null!=list?list:[]}}),_useMergedState2=(0,_slicedToArray2.default)(_useMergedState,2),mergedFileList=_useMergedState2[0],setMergedFileList=_useMergedState2[1],_React$useState=React.useState("drop"),_React$useState2=(0,_slicedToArray2.default)(_React$useState,2),dragState=_React$useState2[0],setDragState=_React$useState2[1],upload=React.useRef();React.useEffect((function(){(0,_devWarning.default)("fileList"in props||!("value"in props),"Upload","`value` is not a valid prop, do you mean `fileList`?"),(0,_devWarning.default)(!("transformFile"in props),"Upload","`transformFile` is deprecated. Please use `beforeUpload` directly.")}),[]),React.useMemo((function(){var timestamp=Date.now();(fileList||[]).forEach((function(file,index){file.uid||Object.isFrozen(file)||(file.uid="__AUTO__".concat(timestamp,"_").concat(index,"__"))}))}),[fileList]);var onInternalChange=function onInternalChange(file,changedFileList,event){var cloneList=(0,_toConsumableArray2.default)(changedFileList);1===maxCount?cloneList=cloneList.slice(-1):maxCount&&(cloneList=cloneList.slice(0,maxCount)),setMergedFileList(cloneList);var changeInfo={file:file,fileList:cloneList};event&&(changeInfo.event=event),null==onChange||onChange(changeInfo)},onBatchStart=function onBatchStart(batchFileInfoList){var filteredFileInfoList=batchFileInfoList.filter((function(info){return!info.file[LIST_IGNORE]}));if(filteredFileInfoList.length){var objectFileList=filteredFileInfoList.map((function(info){return(0,_utils.file2Obj)(info.file)})),newFileList=(0,_toConsumableArray2.default)(mergedFileList);objectFileList.forEach((function(fileObj){newFileList=(0,_utils.updateFileList)(fileObj,newFileList)})),objectFileList.forEach((function(fileObj,index){var triggerFileObj=fileObj;if(filteredFileInfoList[index].parsedFile)fileObj.status="uploading";else{var clone,originFileObj=fileObj.originFileObj;try{clone=new File([originFileObj],originFileObj.name,{type:originFileObj.type})}catch(e){(clone=new Blob([originFileObj],{type:originFileObj.type})).name=originFileObj.name,clone.lastModifiedDate=new Date,clone.lastModified=(new Date).getTime()}clone.uid=fileObj.uid,triggerFileObj=clone}onInternalChange(triggerFileObj,newFileList)}))}},onSuccess=function onSuccess(response,file,xhr){try{"string"==typeof response&&(response=JSON.parse(response))}catch(e){}if((0,_utils.getFileItem)(file,mergedFileList)){var targetItem=(0,_utils.file2Obj)(file);targetItem.status="done",targetItem.percent=100,targetItem.response=response,targetItem.xhr=xhr;var nextFileList=(0,_utils.updateFileList)(targetItem,mergedFileList);onInternalChange(targetItem,nextFileList)}},onProgress=function onProgress(e,file){if((0,_utils.getFileItem)(file,mergedFileList)){var targetItem=(0,_utils.file2Obj)(file);targetItem.status="uploading",targetItem.percent=e.percent;var nextFileList=(0,_utils.updateFileList)(targetItem,mergedFileList);onInternalChange(targetItem,nextFileList,e)}},onError=function onError(error,response,file){if((0,_utils.getFileItem)(file,mergedFileList)){var targetItem=(0,_utils.file2Obj)(file);targetItem.error=error,targetItem.response=response,targetItem.status="error";var nextFileList=(0,_utils.updateFileList)(targetItem,mergedFileList);onInternalChange(targetItem,nextFileList)}},handleRemove=function handleRemove(file){var currentFile;Promise.resolve("function"==typeof onRemove?onRemove(file):onRemove).then((function(ret){var _a;if(!1!==ret){var removedFileList=(0,_utils.removeFileItem)(file,mergedFileList);removedFileList&&(currentFile=(0,_extends2.default)((0,_extends2.default)({},file),{status:"removed"}),null==mergedFileList||mergedFileList.forEach((function(item){var matchKey=void 0!==currentFile.uid?"uid":"name";item[matchKey]!==currentFile[matchKey]||Object.isFrozen(item)||(item.status="removed")})),null===(_a=upload.current)||void 0===_a||_a.abort(currentFile),onInternalChange(currentFile,removedFileList))}}))},onFileDrop=function onFileDrop(e){setDragState(e.type),"drop"===e.type&&(null==onDrop||onDrop(e))};React.useImperativeHandle(ref,(function(){return{onBatchStart:onBatchStart,onSuccess:onSuccess,onProgress:onProgress,onError:onError,fileList:mergedFileList,upload:upload.current}}));var _React$useContext=React.useContext(_configProvider.ConfigContext),getPrefixCls=_React$useContext.getPrefixCls,direction=_React$useContext.direction,prefixCls=getPrefixCls("upload",customizePrefixCls),rcUploadProps=(0,_extends2.default)((0,_extends2.default)({onBatchStart:onBatchStart,onError:onError,onProgress:onProgress,onSuccess:onSuccess},props),{prefixCls:prefixCls,beforeUpload:function mergedBeforeUpload(file,fileListArgs){return __awaiter(void 0,void 0,void 0,_regenerator.default.mark((function _callee(){var beforeUpload,transformFile,parsedFile,result;return _regenerator.default.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(beforeUpload=props.beforeUpload,transformFile=props.transformFile,parsedFile=file,!beforeUpload){_context.next=13;break}return _context.next=5,beforeUpload(file,fileListArgs);case 5:if(!1!==(result=_context.sent)){_context.next=8;break}return _context.abrupt("return",!1);case 8:if(delete file[LIST_IGNORE],result!==LIST_IGNORE){_context.next=12;break}return Object.defineProperty(file,LIST_IGNORE,{value:!0,configurable:!0}),_context.abrupt("return",!1);case 12:"object"===(0,_typeof2.default)(result)&&result&&(parsedFile=result);case 13:if(!transformFile){_context.next=17;break}return _context.next=16,transformFile(parsedFile);case 16:parsedFile=_context.sent;case 17:return _context.abrupt("return",parsedFile);case 18:case"end":return _context.stop()}}),_callee)})))},onChange:void 0});delete rcUploadProps.className,delete rcUploadProps.style,children&&!disabled||delete rcUploadProps.id;var renderUploadList=function renderUploadList(button){return showUploadList?React.createElement(_LocaleReceiver.default,{componentName:"Upload",defaultLocale:_default2.default.Upload},(function(locale){var _ref="boolean"==typeof showUploadList?{}:showUploadList,showRemoveIcon=_ref.showRemoveIcon,showPreviewIcon=_ref.showPreviewIcon,showDownloadIcon=_ref.showDownloadIcon,removeIcon=_ref.removeIcon,downloadIcon=_ref.downloadIcon;return React.createElement(_UploadList.default,{listType:listType,items:mergedFileList,previewFile:previewFile,onPreview:onPreview,onDownload:onDownload,onRemove:handleRemove,showRemoveIcon:!disabled&&showRemoveIcon,showPreviewIcon:showPreviewIcon,showDownloadIcon:showDownloadIcon,removeIcon:removeIcon,downloadIcon:downloadIcon,iconRender:iconRender,locale:(0,_extends2.default)((0,_extends2.default)({},locale),propLocale),isImageUrl:isImageUrl,progress:progress,appendAction:button,itemRender:itemRender})})):button};if("drag"===type){var _classNames,dragCls=(0,_classnames.default)(prefixCls,(_classNames={},(0,_defineProperty2.default)(_classNames,"".concat(prefixCls,"-drag"),!0),(0,_defineProperty2.default)(_classNames,"".concat(prefixCls,"-drag-uploading"),mergedFileList.some((function(file){return"uploading"===file.status}))),(0,_defineProperty2.default)(_classNames,"".concat(prefixCls,"-drag-hover"),"dragover"===dragState),(0,_defineProperty2.default)(_classNames,"".concat(prefixCls,"-disabled"),disabled),(0,_defineProperty2.default)(_classNames,"".concat(prefixCls,"-rtl"),"rtl"===direction),_classNames),className);return React.createElement("span",null,React.createElement("div",{className:dragCls,onDrop:onFileDrop,onDragOver:onFileDrop,onDragLeave:onFileDrop,style:style},React.createElement(_rcUpload.default,(0,_extends2.default)({},rcUploadProps,{ref:upload,className:"".concat(prefixCls,"-btn")}),React.createElement("div",{className:"".concat(prefixCls,"-drag-container")},children))),renderUploadList())}var uploadButtonCls=(0,_classnames.default)(prefixCls,(_classNames2={},(0,_defineProperty2.default)(_classNames2,"".concat(prefixCls,"-select"),!0),(0,_defineProperty2.default)(_classNames2,"".concat(prefixCls,"-select-").concat(listType),!0),(0,_defineProperty2.default)(_classNames2,"".concat(prefixCls,"-disabled"),disabled),(0,_defineProperty2.default)(_classNames2,"".concat(prefixCls,"-rtl"),"rtl"===direction),_classNames2)),uploadButton=React.createElement("div",{className:uploadButtonCls,style:children?void 0:{display:"none"}},React.createElement(_rcUpload.default,(0,_extends2.default)({},rcUploadProps,{ref:upload})));return"picture-card"===listType?React.createElement("span",{className:(0,_classnames.default)("".concat(prefixCls,"-picture-card-wrapper"),className)},renderUploadList(uploadButton)):React.createElement("span",{className:className},uploadButton,renderUploadList())},Upload=React.forwardRef(InternalUpload);Upload.Dragger=_Dragger.default,Upload.LIST_IGNORE=LIST_IGNORE,Upload.displayName="Upload",Upload.defaultProps={type:"select",multiple:!1,action:"",data:{},accept:"",showUploadList:!0,listType:"text",className:"",disabled:!1,supportServerRender:!0};var _default=Upload;exports.default=_default;