"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_extends3=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),React=_interopRequireWildcard(require("react")),_isEqual=_interopRequireDefault(require("lodash/isEqual")),_classnames=_interopRequireDefault(require("classnames")),_rcFieldForm=require("rc-field-form"),_FieldContext=_interopRequireDefault(require("rc-field-form/lib/FieldContext")),_ref2=require("rc-util/lib/ref"),_omit=_interopRequireDefault(require("rc-util/lib/omit")),_row=_interopRequireDefault(require("../grid/row")),_configProvider=require("../config-provider"),_type=require("../_util/type"),_devWarning=_interopRequireDefault(require("../_util/devWarning")),_FormItemLabel=_interopRequireDefault(require("./FormItemLabel")),_FormItemInput=_interopRequireDefault(require("./FormItemInput")),_context=require("./context"),_util=require("./util"),_reactNode=require("../_util/reactNode"),_useFrameState3=_interopRequireDefault(require("./hooks/useFrameState")),_useItemRef=_interopRequireDefault(require("./hooks/useItemRef"));function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof3(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var __rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t},NAME_SPLIT="__SPLIT__",ValidateStatuses=(0,_type.tuple)("success","warning","error","validating",""),MemoInput=React.memo((function(_ref){return _ref.children}),(function(prev,next){return prev.value===next.value&&prev.update===next.update}));function hasValidName(name){return null===name&&(0,_devWarning.default)(!1,"Form.Item","`null` is passed as `name` property"),!(null==name)}function FormItem(props){var name=props.name,fieldKey=props.fieldKey,noStyle=props.noStyle,dependencies=props.dependencies,customizePrefixCls=props.prefixCls,style=props.style,className=props.className,shouldUpdate=props.shouldUpdate,hasFeedback=props.hasFeedback,help=props.help,rules=props.rules,validateStatus=props.validateStatus,children=props.children,required=props.required,label=props.label,messageVariables=props.messageVariables,_props$trigger=props.trigger,trigger=void 0===_props$trigger?"onChange":_props$trigger,validateTrigger=props.validateTrigger,hidden=props.hidden,restProps=__rest(props,["name","fieldKey","noStyle","dependencies","prefixCls","style","className","shouldUpdate","hasFeedback","help","rules","validateStatus","children","required","label","messageVariables","trigger","validateTrigger","hidden"]),destroyRef=(0,React.useRef)(!1),getPrefixCls=(0,React.useContext)(_configProvider.ConfigContext).getPrefixCls,_useContext2=(0,React.useContext)(_context.FormContext),formName=_useContext2.name,requiredMark=_useContext2.requiredMark,updateItemErrors=(0,React.useContext)(_context.FormItemContext).updateItemErrors,_React$useState=React.useState(!!help),_React$useState2=(0,_slicedToArray2.default)(_React$useState,2),domErrorVisible=_React$useState2[0],innerSetDomErrorVisible=_React$useState2[1],_useFrameState=(0,_useFrameState3.default)({}),_useFrameState2=(0,_slicedToArray2.default)(_useFrameState,2),inlineErrors=_useFrameState2[0],setInlineErrors=_useFrameState2[1],contextValidateTrigger=(0,React.useContext)(_FieldContext.default).validateTrigger,mergedValidateTrigger=void 0!==validateTrigger?validateTrigger:contextValidateTrigger;function setDomErrorVisible(visible){destroyRef.current||innerSetDomErrorVisible(visible)}var hasName=hasValidName(name),nameRef=(0,React.useRef)([]);React.useEffect((function(){return function(){destroyRef.current=!0,updateItemErrors(nameRef.current.join(NAME_SPLIT),[])}}),[]);var prefixCls=getPrefixCls("form",customizePrefixCls),updateChildItemErrors=noStyle?updateItemErrors:function(subName,subErrors,originSubName){setInlineErrors((function(){var prevInlineErrors=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return originSubName&&originSubName!==subName&&delete prevInlineErrors[originSubName],(0,_isEqual.default)(prevInlineErrors[subName],subErrors)?prevInlineErrors:(0,_extends3.default)((0,_extends3.default)({},prevInlineErrors),(0,_defineProperty2.default)({},subName,subErrors))}))},getItemRef=(0,_useItemRef.default)();function renderLayout(baseChildren,fieldId,meta,isRequired){var _itemClassName,_a;if(noStyle&&!hidden)return baseChildren;var mergedErrors,subErrorList=[];Object.keys(inlineErrors).forEach((function(subName){subErrorList=[].concat((0,_toConsumableArray2.default)(subErrorList),(0,_toConsumableArray2.default)(inlineErrors[subName]||[]))})),null!=help?mergedErrors=(0,_util.toArray)(help):(mergedErrors=meta?meta.errors:[],mergedErrors=[].concat((0,_toConsumableArray2.default)(mergedErrors),(0,_toConsumableArray2.default)(subErrorList)));var mergedValidateStatus="";void 0!==validateStatus?mergedValidateStatus=validateStatus:(null==meta?void 0:meta.validating)?mergedValidateStatus="validating":(null===(_a=null==meta?void 0:meta.errors)||void 0===_a?void 0:_a.length)||subErrorList.length?mergedValidateStatus="error":(null==meta?void 0:meta.touched)&&(mergedValidateStatus="success");var itemClassName=(_itemClassName={},(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item"),!0),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-with-help"),domErrorVisible||!!help),(0,_defineProperty2.default)(_itemClassName,"".concat(className),!!className),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-has-feedback"),mergedValidateStatus&&hasFeedback),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-has-success"),"success"===mergedValidateStatus),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-has-warning"),"warning"===mergedValidateStatus),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-has-error"),"error"===mergedValidateStatus),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-is-validating"),"validating"===mergedValidateStatus),(0,_defineProperty2.default)(_itemClassName,"".concat(prefixCls,"-item-hidden"),hidden),_itemClassName);return React.createElement(_row.default,(0,_extends3.default)({className:(0,_classnames.default)(itemClassName),style:style,key:"row"},(0,_omit.default)(restProps,["colon","extra","getValueFromEvent","getValueProps","htmlFor","id","initialValue","isListField","labelAlign","labelCol","normalize","preserve","tooltip","validateFirst","valuePropName","wrapperCol","_internalItemRender"])),React.createElement(_FormItemLabel.default,(0,_extends3.default)({htmlFor:fieldId,required:isRequired,requiredMark:requiredMark},props,{prefixCls:prefixCls})),React.createElement(_FormItemInput.default,(0,_extends3.default)({},props,meta,{errors:mergedErrors,prefixCls:prefixCls,status:mergedValidateStatus,onDomErrorVisibleChange:setDomErrorVisible,validateStatus:mergedValidateStatus}),React.createElement(_context.FormItemContext.Provider,{value:{updateItemErrors:updateChildItemErrors}},baseChildren)))}var isRenderProps="function"==typeof children,updateRef=(0,React.useRef)(0);if(updateRef.current+=1,!hasName&&!isRenderProps&&!dependencies)return renderLayout(children);var variables={};return"string"==typeof label?variables.label=label:name&&(variables.label=String(name)),messageVariables&&(variables=(0,_extends3.default)((0,_extends3.default)({},variables),messageVariables)),React.createElement(_rcFieldForm.Field,(0,_extends3.default)({},props,{messageVariables:variables,trigger:trigger,validateTrigger:mergedValidateTrigger,onReset:function onReset(){setDomErrorVisible(!1)}}),(function(control,meta,context){var errors=meta.errors,mergedName=(0,_util.toArray)(name).length&&meta?meta.name:[],fieldId=(0,_util.getFieldId)(mergedName,formName);if(noStyle){var originErrorName=nameRef.current.join(NAME_SPLIT);if(nameRef.current=(0,_toConsumableArray2.default)(mergedName),fieldKey){var fieldKeys=Array.isArray(fieldKey)?fieldKey:[fieldKey];nameRef.current=[].concat((0,_toConsumableArray2.default)(mergedName.slice(0,-1)),(0,_toConsumableArray2.default)(fieldKeys))}updateItemErrors(nameRef.current.join(NAME_SPLIT),errors,originErrorName)}var isRequired=void 0!==required?required:!(!rules||!rules.some((function(rule){if(rule&&"object"===(0,_typeof2.default)(rule)&&rule.required)return!0;if("function"==typeof rule){var ruleEntity=rule(context);return ruleEntity&&ruleEntity.required}return!1}))),mergedControl=(0,_extends3.default)({},control),childNode=null;if((0,_devWarning.default)(!(shouldUpdate&&dependencies),"Form.Item","`shouldUpdate` and `dependencies` shouldn't be used together. See https://ant.design/components/form/#dependencies."),Array.isArray(children)&&hasName)(0,_devWarning.default)(!1,"Form.Item","`children` is array of render props cannot have `name`."),childNode=children;else if(isRenderProps&&(!shouldUpdate&&!dependencies||hasName))(0,_devWarning.default)(!(!shouldUpdate&&!dependencies),"Form.Item","`children` of render props only work with `shouldUpdate` or `dependencies`."),(0,_devWarning.default)(!hasName,"Form.Item","Do not use `name` with `children` of render props since it's not a field.");else if(!dependencies||isRenderProps||hasName)if((0,_reactNode.isValidElement)(children)){(0,_devWarning.default)(void 0===children.props.defaultValue,"Form.Item","`defaultValue` will not work on controlled Field. You should use `initialValues` of Form instead.");var childProps=(0,_extends3.default)((0,_extends3.default)({},children.props),mergedControl);childProps.id||(childProps.id=fieldId),(0,_ref2.supportRef)(children)&&(childProps.ref=getItemRef(mergedName,children)),new Set([].concat((0,_toConsumableArray2.default)((0,_util.toArray)(trigger)),(0,_toConsumableArray2.default)((0,_util.toArray)(mergedValidateTrigger)))).forEach((function(eventName){childProps[eventName]=function(){for(var _a2,_c2,_a,_b,_c,_len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];null===(_a=mergedControl[eventName])||void 0===_a||(_a2=_a).call.apply(_a2,[mergedControl].concat(args)),null===(_c=(_b=children.props)[eventName])||void 0===_c||(_c2=_c).call.apply(_c2,[_b].concat(args))}})),childNode=React.createElement(MemoInput,{value:mergedControl[props.valuePropName||"value"],update:updateRef.current},(0,_reactNode.cloneElement)(children,childProps))}else isRenderProps&&(shouldUpdate||dependencies)&&!hasName?childNode=children(context):((0,_devWarning.default)(!mergedName.length,"Form.Item","`name` is only used for validate React element. If you are using Form.Item as layout display, please remove `name` instead."),childNode=children);else(0,_devWarning.default)(!1,"Form.Item","Must set `name` or use render props when `dependencies` is set.");return renderLayout(childNode,fieldId,meta,isRequired)}))}var _default=FormItem;exports.default=_default;