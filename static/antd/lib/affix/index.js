"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_createSuper2=_interopRequireDefault(require("@babel/runtime/helpers/createSuper")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),React=_interopRequireWildcard(require("react")),_classnames=_interopRequireDefault(require("classnames")),_omit=_interopRequireDefault(require("rc-util/lib/omit")),_rcResizeObserver=_interopRequireDefault(require("rc-resize-observer")),_configProvider=require("../config-provider"),_throttleByAnimationFrame=require("../_util/throttleByAnimationFrame"),_utils=require("./utils");function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof3(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var AffixStatus,__decorate=function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"===("undefined"==typeof Reflect?"undefined":(0,_typeof2.default)(Reflect))&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r};function getDefaultTarget(){return"undefined"!=typeof window?window:null}!function(AffixStatus){AffixStatus[AffixStatus.None=0]="None",AffixStatus[AffixStatus.Prepare=1]="Prepare"}(AffixStatus||(AffixStatus={}));var Affix=function(_React$Component){(0,_inherits2.default)(Affix,_React$Component);var _super=(0,_createSuper2.default)(Affix);function Affix(){var _this;return(0,_classCallCheck2.default)(this,Affix),(_this=_super.apply(this,arguments)).state={status:AffixStatus.None,lastAffix:!1,prevTarget:null},_this.getOffsetTop=function(){var offsetBottom=_this.props.offsetBottom,offsetTop=_this.props.offsetTop;return void 0===offsetBottom&&void 0===offsetTop&&(offsetTop=0),offsetTop},_this.getOffsetBottom=function(){return _this.props.offsetBottom},_this.savePlaceholderNode=function(node){_this.placeholderNode=node},_this.saveFixedNode=function(node){_this.fixedNode=node},_this.measure=function(){var _this$state=_this.state,status=_this$state.status,lastAffix=_this$state.lastAffix,onChange=_this.props.onChange,targetFunc=_this.getTargetFunc();if(status===AffixStatus.Prepare&&_this.fixedNode&&_this.placeholderNode&&targetFunc){var offsetTop=_this.getOffsetTop(),offsetBottom=_this.getOffsetBottom(),targetNode=targetFunc();if(targetNode){var newState={status:AffixStatus.None},targetRect=(0,_utils.getTargetRect)(targetNode),placeholderReact=(0,_utils.getTargetRect)(_this.placeholderNode),fixedTop=(0,_utils.getFixedTop)(placeholderReact,targetRect,offsetTop),fixedBottom=(0,_utils.getFixedBottom)(placeholderReact,targetRect,offsetBottom);void 0!==fixedTop?(newState.affixStyle={position:"fixed",top:fixedTop,width:placeholderReact.width,height:placeholderReact.height},newState.placeholderStyle={width:placeholderReact.width,height:placeholderReact.height}):void 0!==fixedBottom&&(newState.affixStyle={position:"fixed",bottom:fixedBottom,width:placeholderReact.width,height:placeholderReact.height},newState.placeholderStyle={width:placeholderReact.width,height:placeholderReact.height}),newState.lastAffix=!!newState.affixStyle,onChange&&lastAffix!==newState.lastAffix&&onChange(newState.lastAffix),_this.setState(newState)}}},_this.prepareMeasure=function(){if(_this.setState({status:AffixStatus.Prepare,affixStyle:void 0,placeholderStyle:void 0}),"test"===process.env.NODE_ENV){var onTestUpdatePosition=_this.props.onTestUpdatePosition;null==onTestUpdatePosition||onTestUpdatePosition()}},_this.render=function(){var getPrefixCls=_this.context.getPrefixCls,_this$state2=_this.state,affixStyle=_this$state2.affixStyle,placeholderStyle=_this$state2.placeholderStyle,_this$props=_this.props,prefixCls=_this$props.prefixCls,children=_this$props.children,className=(0,_classnames.default)((0,_defineProperty2.default)({},getPrefixCls("affix",prefixCls),!!affixStyle)),props=(0,_omit.default)(_this.props,["prefixCls","offsetTop","offsetBottom","target","onChange"]);return"test"===process.env.NODE_ENV&&(props=(0,_omit.default)(props,["onTestUpdatePosition"])),React.createElement(_rcResizeObserver.default,{onResize:function onResize(){_this.updatePosition()}},React.createElement("div",(0,_extends2.default)({},props,{ref:_this.savePlaceholderNode}),affixStyle&&React.createElement("div",{style:placeholderStyle,"aria-hidden":"true"}),React.createElement("div",{className:className,ref:_this.saveFixedNode,style:affixStyle},React.createElement(_rcResizeObserver.default,{onResize:function onResize(){_this.updatePosition()}},children))))},_this}return(0,_createClass2.default)(Affix,[{key:"getTargetFunc",value:function getTargetFunc(){var getTargetContainer=this.context.getTargetContainer,target=this.props.target;return void 0!==target?target:getTargetContainer||getDefaultTarget}},{key:"componentDidMount",value:function componentDidMount(){var _this2=this,targetFunc=this.getTargetFunc();targetFunc&&(this.timeout=setTimeout((function(){(0,_utils.addObserveTarget)(targetFunc(),_this2),_this2.updatePosition()})))}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){var prevTarget=this.state.prevTarget,targetFunc=this.getTargetFunc(),newTarget=null;targetFunc&&(newTarget=targetFunc()||null),prevTarget!==newTarget&&((0,_utils.removeObserveTarget)(this),newTarget&&((0,_utils.addObserveTarget)(newTarget,this),this.updatePosition()),this.setState({prevTarget:newTarget})),prevProps.offsetTop===this.props.offsetTop&&prevProps.offsetBottom===this.props.offsetBottom||this.updatePosition(),this.measure()}},{key:"componentWillUnmount",value:function componentWillUnmount(){clearTimeout(this.timeout),(0,_utils.removeObserveTarget)(this),this.updatePosition.cancel(),this.lazyUpdatePosition.cancel()}},{key:"updatePosition",value:function updatePosition(){this.prepareMeasure()}},{key:"lazyUpdatePosition",value:function lazyUpdatePosition(){var targetFunc=this.getTargetFunc(),affixStyle=this.state.affixStyle;if(targetFunc&&affixStyle){var offsetTop=this.getOffsetTop(),offsetBottom=this.getOffsetBottom(),targetNode=targetFunc();if(targetNode&&this.placeholderNode){var targetRect=(0,_utils.getTargetRect)(targetNode),placeholderReact=(0,_utils.getTargetRect)(this.placeholderNode),fixedTop=(0,_utils.getFixedTop)(placeholderReact,targetRect,offsetTop),fixedBottom=(0,_utils.getFixedBottom)(placeholderReact,targetRect,offsetBottom);if(void 0!==fixedTop&&affixStyle.top===fixedTop||void 0!==fixedBottom&&affixStyle.bottom===fixedBottom)return}}this.prepareMeasure()}}]),Affix}(React.Component);Affix.contextType=_configProvider.ConfigContext,__decorate([(0,_throttleByAnimationFrame.throttleByAnimationFrameDecorator)()],Affix.prototype,"updatePosition",null),__decorate([(0,_throttleByAnimationFrame.throttleByAnimationFrameDecorator)()],Affix.prototype,"lazyUpdatePosition",null);var _default=Affix;exports.default=_default;