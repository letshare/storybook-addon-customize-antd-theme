"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _reactDom=require("react-dom"),React=_interopRequireWildcard(require("react")),_toArray=_interopRequireDefault(require("rc-util/lib/Children/toArray"));function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var ellipsisContainer,ELEMENT_NODE=1,TEXT_NODE=3,COMMENT_NODE=8,wrapperStyle={padding:0,margin:0,display:"inline",lineHeight:"inherit"};function pxToNumber(value){if(!value)return 0;var match=value.match(/^\d*(\.\d*)?/);return match?Number(match[0]):0}function styleToString(style){return Array.prototype.slice.apply(style).map((function(name){return"".concat(name,": ").concat(style.getPropertyValue(name),";")})).join("")}function mergeChildren(children){var childList=[];return children.forEach((function(child){var prevChild=childList[childList.length-1];"string"==typeof child&&"string"==typeof prevChild?childList[childList.length-1]+=child:childList.push(child)})),childList}function resetDomStyles(target,origin){target.setAttribute("aria-hidden","true");var originCSS=styleToString(window.getComputedStyle(origin));target.setAttribute("style",originCSS),target.style.position="fixed",target.style.left="0",target.style.height="auto",target.style.minHeight="auto",target.style.maxHeight="auto",target.style.top="-999999px",target.style.zIndex="-1000",target.style.textOverflow="clip",target.style.whiteSpace="normal",target.style.webkitLineClamp="none"}function getRealLineHeight(originElement){var heightContainer=document.createElement("div");resetDomStyles(heightContainer,originElement),heightContainer.appendChild(document.createTextNode("text")),document.body.appendChild(heightContainer);var offsetHeight=heightContainer.offsetHeight,lineHeight=pxToNumber(window.getComputedStyle(originElement).lineHeight);return document.body.removeChild(heightContainer),offsetHeight>lineHeight?offsetHeight:lineHeight}var _default=function _default(originElement,option,content,fixedContent,ellipsisStr){ellipsisContainer||(ellipsisContainer=document.createElement("div")).setAttribute("aria-hidden","true"),ellipsisContainer.parentNode||document.body.appendChild(ellipsisContainer);var rows=option.rows,_option$suffix=option.suffix,suffix=void 0===_option$suffix?"":_option$suffix,originStyle=window.getComputedStyle(originElement),lineHeight=getRealLineHeight(originElement),maxHeight=Math.floor(lineHeight)*(rows+1)+pxToNumber(originStyle.paddingTop)+pxToNumber(originStyle.paddingBottom);resetDomStyles(ellipsisContainer,originElement);var contentList=mergeChildren((0,_toArray.default)(content));function inRange(){return Math.ceil(ellipsisContainer.getBoundingClientRect().height)<maxHeight}if((0,_reactDom.render)(React.createElement("div",{style:wrapperStyle},React.createElement("span",{style:wrapperStyle},contentList,suffix),React.createElement("span",{style:wrapperStyle},fixedContent)),ellipsisContainer),inRange())return(0,_reactDom.unmountComponentAtNode)(ellipsisContainer),{content:content,text:ellipsisContainer.innerHTML,ellipsis:!1};var childNodes=Array.prototype.slice.apply(ellipsisContainer.childNodes[0].childNodes[0].cloneNode(!0).childNodes).filter((function(_ref){return _ref.nodeType!==COMMENT_NODE})),fixedNodes=Array.prototype.slice.apply(ellipsisContainer.childNodes[0].childNodes[1].cloneNode(!0).childNodes);(0,_reactDom.unmountComponentAtNode)(ellipsisContainer);var ellipsisChildren=[];ellipsisContainer.innerHTML="";var ellipsisContentHolder=document.createElement("span");ellipsisContainer.appendChild(ellipsisContentHolder);var ellipsisTextNode=document.createTextNode(ellipsisStr+suffix);function appendChildNode(node){ellipsisContentHolder.insertBefore(node,ellipsisTextNode)}function measureText(textNode,fullText){var startLoc=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,endLoc=arguments.length>3&&void 0!==arguments[3]?arguments[3]:fullText.length,lastSuccessLoc=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,midLoc=Math.floor((startLoc+endLoc)/2),currentText=fullText.slice(0,midLoc);if(textNode.textContent=currentText,startLoc>=endLoc-1)for(var step=endLoc;step>=startLoc;step-=1){var currentStepText=fullText.slice(0,step);if(textNode.textContent=currentStepText,inRange()||!currentStepText)return step===fullText.length?{finished:!1,reactNode:fullText}:{finished:!0,reactNode:currentStepText}}return inRange()?measureText(textNode,fullText,midLoc,endLoc,midLoc):measureText(textNode,fullText,startLoc,midLoc,lastSuccessLoc)}function measureNode(childNode,index){var type=childNode.nodeType;if(type===ELEMENT_NODE)return appendChildNode(childNode),inRange()?{finished:!1,reactNode:contentList[index]}:(ellipsisContentHolder.removeChild(childNode),{finished:!0,reactNode:null});if(type===TEXT_NODE){var fullText=childNode.textContent||"",textNode=document.createTextNode(fullText);return appendChildNode(textNode),measureText(textNode,fullText)}return{finished:!1,reactNode:null}}return ellipsisContentHolder.appendChild(ellipsisTextNode),fixedNodes.forEach((function(childNode){ellipsisContainer.appendChild(childNode)})),childNodes.some((function(childNode,index){var _measureNode=measureNode(childNode,index),finished=_measureNode.finished,reactNode=_measureNode.reactNode;return reactNode&&ellipsisChildren.push(reactNode),finished})),{content:ellipsisChildren,text:ellipsisContainer.innerHTML,ellipsis:!0}};exports.default=_default;