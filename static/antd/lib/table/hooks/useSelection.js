"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=useSelection,exports.SELECTION_NONE=exports.SELECTION_INVERT=exports.SELECTION_ALL=void 0;var _toArray2=_interopRequireDefault(require("@babel/runtime/helpers/toArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),React=_interopRequireWildcard(require("react")),_DownOutlined=_interopRequireDefault(require("@ant-design/icons/DownOutlined")),_treeUtil=require("rc-tree/lib/utils/treeUtil"),_conductUtil=require("rc-tree/lib/utils/conductUtil"),_util=require("rc-tree/lib/util"),_rcTable=require("rc-table"),_useMergedState3=_interopRequireDefault(require("rc-util/lib/hooks/useMergedState")),_checkbox=_interopRequireDefault(require("../../checkbox")),_dropdown=_interopRequireDefault(require("../../dropdown")),_menu=_interopRequireDefault(require("../../menu")),_radio=_interopRequireDefault(require("../../radio")),_devWarning=_interopRequireDefault(require("../../_util/devWarning"));function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof3(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var SELECTION_ALL="SELECT_ALL";exports.SELECTION_ALL=SELECTION_ALL;var SELECTION_INVERT="SELECT_INVERT";exports.SELECTION_INVERT=SELECTION_INVERT;var SELECTION_NONE="SELECT_NONE";function getFixedType(column){return column&&column.fixed}function flattenData(data,childrenColumnName){var list=[];return(data||[]).forEach((function(record){list.push(record),record&&"object"===(0,_typeof2.default)(record)&&childrenColumnName in record&&(list=[].concat((0,_toConsumableArray2.default)(list),(0,_toConsumableArray2.default)(flattenData(record[childrenColumnName],childrenColumnName))))})),list}function useSelection(rowSelection,config){var _ref=rowSelection||{},preserveSelectedRowKeys=_ref.preserveSelectedRowKeys,selectedRowKeys=_ref.selectedRowKeys,defaultSelectedRowKeys=_ref.defaultSelectedRowKeys,getCheckboxProps=_ref.getCheckboxProps,onSelectionChange=_ref.onChange,onSelect=_ref.onSelect,onSelectAll=_ref.onSelectAll,onSelectInvert=_ref.onSelectInvert,onSelectNone=_ref.onSelectNone,onSelectMultiple=_ref.onSelectMultiple,selectionColWidth=_ref.columnWidth,selectionType=_ref.type,selections=_ref.selections,fixed=_ref.fixed,customizeRenderCell=_ref.renderCell,hideSelectAll=_ref.hideSelectAll,_ref$checkStrictly=_ref.checkStrictly,checkStrictly=void 0===_ref$checkStrictly||_ref$checkStrictly,prefixCls=config.prefixCls,data=config.data,pageData=config.pageData,getRecordByKey=config.getRecordByKey,getRowKey=config.getRowKey,expandType=config.expandType,childrenColumnName=config.childrenColumnName,tableLocale=config.locale,expandIconColumnIndex=config.expandIconColumnIndex,getPopupContainer=config.getPopupContainer,_useMergedState=(0,_useMergedState3.default)(selectedRowKeys||defaultSelectedRowKeys||[],{value:selectedRowKeys}),_useMergedState2=(0,_slicedToArray2.default)(_useMergedState,2),mergedSelectedKeys=_useMergedState2[0],setMergedSelectedKeys=_useMergedState2[1],preserveRecordsRef=React.useRef(new Map),updatePreserveRecordsCache=(0,React.useCallback)((function(keys){if(preserveSelectedRowKeys){var newCache=new Map;keys.forEach((function(key){var record=getRecordByKey(key);!record&&preserveRecordsRef.current.has(key)&&(record=preserveRecordsRef.current.get(key)),newCache.set(key,record)})),preserveRecordsRef.current=newCache}}),[getRecordByKey,preserveSelectedRowKeys]);React.useEffect((function(){updatePreserveRecordsCache(mergedSelectedKeys)}),[mergedSelectedKeys]);var keyEntities=(0,React.useMemo)((function(){return checkStrictly?{keyEntities:null}:(0,_treeUtil.convertDataToEntities)(data,{externalGetKey:getRowKey,childrenPropName:childrenColumnName})}),[data,getRowKey,checkStrictly,childrenColumnName]).keyEntities,flattedData=(0,React.useMemo)((function(){return flattenData(pageData,childrenColumnName)}),[pageData,childrenColumnName]),checkboxPropsMap=(0,React.useMemo)((function(){var map=new Map;return flattedData.forEach((function(record,index){var key=getRowKey(record,index),checkboxProps=(getCheckboxProps?getCheckboxProps(record):null)||{};map.set(key,checkboxProps),"production"!==process.env.NODE_ENV&&("checked"in checkboxProps||"defaultChecked"in checkboxProps)&&(0,_devWarning.default)(!1,"Table","Do not set `checked` or `defaultChecked` in `getCheckboxProps`. Please use `selectedRowKeys` instead.")})),map}),[flattedData,getRowKey,getCheckboxProps]),isCheckboxDisabled=(0,React.useCallback)((function(r){var _a;return!!(null===(_a=checkboxPropsMap.get(getRowKey(r)))||void 0===_a?void 0:_a.disabled)}),[checkboxPropsMap,getRowKey]),_useMemo2=(0,React.useMemo)((function(){if(checkStrictly)return[mergedSelectedKeys||[],[]];var _conductCheck=(0,_conductUtil.conductCheck)(mergedSelectedKeys,!0,keyEntities,isCheckboxDisabled);return[_conductCheck.checkedKeys||[],_conductCheck.halfCheckedKeys]}),[mergedSelectedKeys,checkStrictly,keyEntities,isCheckboxDisabled]),_useMemo3=(0,_slicedToArray2.default)(_useMemo2,2),derivedSelectedKeys=_useMemo3[0],derivedHalfSelectedKeys=_useMemo3[1],derivedSelectedKeySet=(0,React.useMemo)((function(){var keys="radio"===selectionType?derivedSelectedKeys.slice(0,1):derivedSelectedKeys;return new Set(keys)}),[derivedSelectedKeys,selectionType]),derivedHalfSelectedKeySet=(0,React.useMemo)((function(){return"radio"===selectionType?new Set:new Set(derivedHalfSelectedKeys)}),[derivedHalfSelectedKeys,selectionType]),_useState=(0,React.useState)(null),_useState2=(0,_slicedToArray2.default)(_useState,2),lastSelectedKey=_useState2[0],setLastSelectedKey=_useState2[1];React.useEffect((function(){rowSelection||setMergedSelectedKeys([])}),[!!rowSelection]);var setSelectedKeys=(0,React.useCallback)((function(keys){var availableKeys,records;updatePreserveRecordsCache(keys),preserveSelectedRowKeys?(availableKeys=keys,records=keys.map((function(key){return preserveRecordsRef.current.get(key)}))):(availableKeys=[],records=[],keys.forEach((function(key){var record=getRecordByKey(key);void 0!==record&&(availableKeys.push(key),records.push(record))}))),setMergedSelectedKeys(availableKeys),null==onSelectionChange||onSelectionChange(availableKeys,records)}),[setMergedSelectedKeys,getRecordByKey,onSelectionChange,preserveSelectedRowKeys]),triggerSingleSelection=(0,React.useCallback)((function(key,selected,keys,event){if(onSelect){var rows=keys.map((function(k){return getRecordByKey(k)}));onSelect(getRecordByKey(key),selected,rows,event)}setSelectedKeys(keys)}),[onSelect,getRecordByKey,setSelectedKeys]),mergedSelections=(0,React.useMemo)((function(){return!selections||hideSelectAll?null:(!0===selections?[SELECTION_ALL,SELECTION_INVERT,SELECTION_NONE]:selections).map((function(selection){return selection===SELECTION_ALL?{key:"all",text:tableLocale.selectionAll,onSelect:function onSelect(){setSelectedKeys(data.map((function(record,index){return getRowKey(record,index)})))}}:selection===SELECTION_INVERT?{key:"invert",text:tableLocale.selectInvert,onSelect:function onSelect(){var keySet=new Set(derivedSelectedKeySet);pageData.forEach((function(record,index){var key=getRowKey(record,index);keySet.has(key)?keySet.delete(key):keySet.add(key)}));var keys=Array.from(keySet);onSelectInvert&&((0,_devWarning.default)(!1,"Table","`onSelectInvert` will be removed in future. Please use `onChange` instead."),onSelectInvert(keys)),setSelectedKeys(keys)}}:selection===SELECTION_NONE?{key:"none",text:tableLocale.selectNone,onSelect:function onSelect(){null==onSelectNone||onSelectNone(),setSelectedKeys([])}}:selection}))}),[selections,derivedSelectedKeySet,pageData,getRowKey,onSelectInvert,setSelectedKeys]);return[(0,React.useCallback)((function(columns){if(!rowSelection)return columns;var title,renderCell,keySet=new Set(derivedSelectedKeySet),recordKeys=flattedData.map(getRowKey).filter((function(key){return!checkboxPropsMap.get(key).disabled})),checkedCurrentAll=recordKeys.every((function(key){return keySet.has(key)})),checkedCurrentSome=recordKeys.some((function(key){return keySet.has(key)}));if("radio"!==selectionType){var customizeSelections;if(mergedSelections){var menu=React.createElement(_menu.default,{getPopupContainer:getPopupContainer},mergedSelections.map((function(selection,index){var key=selection.key,text=selection.text,onSelectionClick=selection.onSelect;return React.createElement(_menu.default.Item,{key:key||index,onClick:function onClick(){null==onSelectionClick||onSelectionClick(recordKeys)}},text)})));customizeSelections=React.createElement("div",{className:"".concat(prefixCls,"-selection-extra")},React.createElement(_dropdown.default,{overlay:menu,getPopupContainer:getPopupContainer},React.createElement("span",null,React.createElement(_DownOutlined.default,null))))}var allDisabledData=flattedData.map((function(record,index){var key=getRowKey(record,index),checkboxProps=checkboxPropsMap.get(key)||{};return(0,_extends2.default)({checked:keySet.has(key)},checkboxProps)})).filter((function(_ref2){return _ref2.disabled})),allDisabled=!!allDisabledData.length&&allDisabledData.length===flattedData.length,allDisabledAndChecked=allDisabled&&allDisabledData.every((function(_ref3){return _ref3.checked})),allDisabledSomeChecked=allDisabled&&allDisabledData.some((function(_ref4){return _ref4.checked}));title=!hideSelectAll&&React.createElement("div",{className:"".concat(prefixCls,"-selection")},React.createElement(_checkbox.default,{checked:allDisabled?allDisabledAndChecked:!!flattedData.length&&checkedCurrentAll,indeterminate:allDisabled?!allDisabledAndChecked&&allDisabledSomeChecked:!checkedCurrentAll&&checkedCurrentSome,onChange:function onSelectAllChange(){var changeKeys=[];checkedCurrentAll?recordKeys.forEach((function(key){keySet.delete(key),changeKeys.push(key)})):recordKeys.forEach((function(key){keySet.has(key)||(keySet.add(key),changeKeys.push(key))}));var keys=Array.from(keySet);null==onSelectAll||onSelectAll(!checkedCurrentAll,keys.map((function(k){return getRecordByKey(k)})),changeKeys.map((function(k){return getRecordByKey(k)}))),setSelectedKeys(keys)},disabled:0===flattedData.length||allDisabled,skipGroup:!0}),customizeSelections)}renderCell="radio"===selectionType?function renderCell(_,record,index){var key=getRowKey(record,index),checked=keySet.has(key);return{node:React.createElement(_radio.default,(0,_extends2.default)({},checkboxPropsMap.get(key),{checked:checked,onClick:function onClick(e){return e.stopPropagation()},onChange:function onChange(event){keySet.has(key)||triggerSingleSelection(key,!0,[key],event.nativeEvent)}})),checked:checked}}:function renderCell(_,record,index){var _a,mergedIndeterminate,key=getRowKey(record,index),checked=keySet.has(key),indeterminate=derivedHalfSelectedKeySet.has(key),checkboxProps=checkboxPropsMap.get(key);return"nest"===expandType?(mergedIndeterminate=indeterminate,(0,_devWarning.default)("boolean"!=typeof(null==checkboxProps?void 0:checkboxProps.indeterminate),"Table","set `indeterminate` using `rowSelection.getCheckboxProps` is not allowed with tree structured dataSource.")):mergedIndeterminate=null!==(_a=null==checkboxProps?void 0:checkboxProps.indeterminate)&&void 0!==_a?_a:indeterminate,{node:React.createElement(_checkbox.default,(0,_extends2.default)({},checkboxProps,{indeterminate:mergedIndeterminate,checked:checked,skipGroup:!0,onClick:function onClick(e){return e.stopPropagation()},onChange:function onChange(_ref5){var nativeEvent=_ref5.nativeEvent,shiftKey=nativeEvent.shiftKey,startIndex=-1,endIndex=-1;if(shiftKey&&checkStrictly){var pointKeys=new Set([lastSelectedKey,key]);recordKeys.some((function(recordKey,recordIndex){if(pointKeys.has(recordKey)){if(-1!==startIndex)return endIndex=recordIndex,!0;startIndex=recordIndex}return!1}))}if(-1!==endIndex&&startIndex!==endIndex&&checkStrictly){var rangeKeys=recordKeys.slice(startIndex,endIndex+1),changedKeys=[];checked?rangeKeys.forEach((function(recordKey){keySet.has(recordKey)&&(changedKeys.push(recordKey),keySet.delete(recordKey))})):rangeKeys.forEach((function(recordKey){keySet.has(recordKey)||(changedKeys.push(recordKey),keySet.add(recordKey))}));var keys=Array.from(keySet);null==onSelectMultiple||onSelectMultiple(!checked,keys.map((function(recordKey){return getRecordByKey(recordKey)})),changedKeys.map((function(recordKey){return getRecordByKey(recordKey)}))),setSelectedKeys(keys)}else{var originCheckedKeys=derivedSelectedKeys;if(checkStrictly){var checkedKeys=checked?(0,_util.arrDel)(originCheckedKeys,key):(0,_util.arrAdd)(originCheckedKeys,key);triggerSingleSelection(key,!checked,checkedKeys,nativeEvent)}else{var result=(0,_conductUtil.conductCheck)([].concat((0,_toConsumableArray2.default)(originCheckedKeys),[key]),!0,keyEntities,isCheckboxDisabled),_checkedKeys=result.checkedKeys,halfCheckedKeys=result.halfCheckedKeys,nextCheckedKeys=_checkedKeys;if(checked){var tempKeySet=new Set(_checkedKeys);tempKeySet.delete(key),nextCheckedKeys=(0,_conductUtil.conductCheck)(Array.from(tempKeySet),{checked:!1,halfCheckedKeys:halfCheckedKeys},keyEntities,isCheckboxDisabled).checkedKeys}triggerSingleSelection(key,!checked,nextCheckedKeys,nativeEvent)}}setLastSelectedKey(key)}})),checked:checked}};var selectionColumn=(0,_defineProperty2.default)({width:selectionColWidth,className:"".concat(prefixCls,"-selection-column"),title:rowSelection.columnTitle||title,render:function renderSelectionCell(_,record,index){var _renderCell=renderCell(_,record,index),node=_renderCell.node,checked=_renderCell.checked;return customizeRenderCell?customizeRenderCell(checked,record,index,node):node}},_rcTable.INTERNAL_COL_DEFINE,{className:"".concat(prefixCls,"-selection-col")});if("row"===expandType&&columns.length&&!expandIconColumnIndex){var _columns=(0,_toArray2.default)(columns),expandColumn=_columns[0],restColumns=_columns.slice(1),selectionFixed=fixed||getFixedType(restColumns[0]);return selectionFixed&&(expandColumn.fixed=selectionFixed),[expandColumn,(0,_extends2.default)((0,_extends2.default)({},selectionColumn),{fixed:selectionFixed})].concat((0,_toConsumableArray2.default)(restColumns))}return[(0,_extends2.default)((0,_extends2.default)({},selectionColumn),{fixed:fixed||getFixedType(columns[0])})].concat((0,_toConsumableArray2.default)(columns))}),[getRowKey,flattedData,rowSelection,derivedSelectedKeys,derivedSelectedKeySet,derivedHalfSelectedKeySet,selectionColWidth,mergedSelections,expandType,lastSelectedKey,checkboxPropsMap,onSelectMultiple,triggerSingleSelection,isCheckboxDisabled]),derivedSelectedKeySet]}exports.SELECTION_NONE=SELECTION_NONE;