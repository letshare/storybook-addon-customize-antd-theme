"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFilterData=getFilterData,exports.default=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),React=_interopRequireWildcard(require("react")),_devWarning=_interopRequireDefault(require("../../../_util/devWarning")),_util=require("../../util"),_FilterDropdown=_interopRequireDefault(require("./FilterDropdown"));function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function collectFilterStates(columns,init,pos){var filterStates=[];return(columns||[]).forEach((function(column,index){var _a,columnPos=(0,_util.getColumnPos)(index,pos);if(column.filters||"filterDropdown"in column||"onFilter"in column)if("filteredValue"in column){var filteredValues=column.filteredValue;"filterDropdown"in column||(filteredValues=null!==(_a=null==filteredValues?void 0:filteredValues.map(String))&&void 0!==_a?_a:filteredValues),filterStates.push({column:column,key:(0,_util.getColumnKey)(column,columnPos),filteredKeys:filteredValues,forceFiltered:column.filtered})}else filterStates.push({column:column,key:(0,_util.getColumnKey)(column,columnPos),filteredKeys:init&&column.defaultFilteredValue?column.defaultFilteredValue:void 0,forceFiltered:column.filtered});"children"in column&&(filterStates=[].concat((0,_toConsumableArray2.default)(filterStates),(0,_toConsumableArray2.default)(collectFilterStates(column.children,init,columnPos))))})),filterStates}function injectFilter(prefixCls,dropdownPrefixCls,columns,filterStates,triggerFilter,getPopupContainer,locale,pos){return columns.map((function(column,index){var columnPos=(0,_util.getColumnPos)(index,pos),_column$filterMultipl=column.filterMultiple,filterMultiple=void 0===_column$filterMultipl||_column$filterMultipl,newColumn=column;if(newColumn.filters||newColumn.filterDropdown){var columnKey=(0,_util.getColumnKey)(newColumn,columnPos),filterState=filterStates.find((function(_ref){var key=_ref.key;return columnKey===key}));newColumn=(0,_extends2.default)((0,_extends2.default)({},newColumn),{title:function title(renderProps){return React.createElement(_FilterDropdown.default,{tablePrefixCls:prefixCls,prefixCls:"".concat(prefixCls,"-filter"),dropdownPrefixCls:dropdownPrefixCls,column:newColumn,columnKey:columnKey,filterState:filterState,filterMultiple:filterMultiple,triggerFilter:triggerFilter,locale:locale,getPopupContainer:getPopupContainer},(0,_util.renderColumnTitle)(column.title,renderProps))}})}return"children"in newColumn&&(newColumn=(0,_extends2.default)((0,_extends2.default)({},newColumn),{children:injectFilter(prefixCls,dropdownPrefixCls,newColumn.children,filterStates,triggerFilter,getPopupContainer,locale,columnPos)})),newColumn}))}function flattenKeys(filters){var keys=[];return(filters||[]).forEach((function(_ref2){var value=_ref2.value,children=_ref2.children;keys.push(value),children&&(keys=[].concat((0,_toConsumableArray2.default)(keys),(0,_toConsumableArray2.default)(flattenKeys(children))))})),keys}function generateFilterInfo(filterStates){var currentFilters={};return filterStates.forEach((function(_ref3){var key=_ref3.key,filteredKeys=_ref3.filteredKeys,column=_ref3.column,filters=column.filters;if(column.filterDropdown)currentFilters[key]=filteredKeys||null;else if(Array.isArray(filteredKeys)){var keys=flattenKeys(filters);currentFilters[key]=keys.filter((function(originKey){return filteredKeys.includes(String(originKey))}))}else currentFilters[key]=null})),currentFilters}function getFilterData(data,filterStates){return filterStates.reduce((function(currentData,filterState){var _filterState$column=filterState.column,onFilter=_filterState$column.onFilter,filters=_filterState$column.filters,filteredKeys=filterState.filteredKeys;return onFilter&&filteredKeys&&filteredKeys.length?currentData.filter((function(record){return filteredKeys.some((function(key){var keys=flattenKeys(filters),keyIndex=keys.findIndex((function(k){return String(k)===String(key)})),realKey=-1!==keyIndex?keys[keyIndex]:key;return onFilter(realKey,record)}))})):currentData}),data)}function useFilter(_ref4){var prefixCls=_ref4.prefixCls,dropdownPrefixCls=_ref4.dropdownPrefixCls,mergedColumns=_ref4.mergedColumns,onFilterChange=_ref4.onFilterChange,getPopupContainer=_ref4.getPopupContainer,tableLocale=_ref4.locale,_React$useState=React.useState(collectFilterStates(mergedColumns,!0)),_React$useState2=(0,_slicedToArray2.default)(_React$useState,2),filterStates=_React$useState2[0],setFilterStates=_React$useState2[1],mergedFilterStates=React.useMemo((function(){var collectedStates=collectFilterStates(mergedColumns,!1),filteredKeysIsNotControlled=collectedStates.every((function(_ref5){return void 0===_ref5.filteredKeys}));if(filteredKeysIsNotControlled)return filterStates;var filteredKeysIsAllControlled=collectedStates.every((function(_ref6){return void 0!==_ref6.filteredKeys}));return(0,_devWarning.default)(filteredKeysIsNotControlled||filteredKeysIsAllControlled,"Table","`FilteredKeys` should all be controlled or not controlled."),collectedStates}),[mergedColumns,filterStates]),getFilters=React.useCallback((function(){return generateFilterInfo(mergedFilterStates)}),[mergedFilterStates]),triggerFilter=function triggerFilter(filterState){var newFilterStates=mergedFilterStates.filter((function(_ref7){return _ref7.key!==filterState.key}));newFilterStates.push(filterState),setFilterStates(newFilterStates),onFilterChange(generateFilterInfo(newFilterStates),newFilterStates)};return[function transformColumns(innerColumns){return injectFilter(prefixCls,dropdownPrefixCls,innerColumns,mergedFilterStates,triggerFilter,getPopupContainer,tableLocale)},mergedFilterStates,getFilters]}var _default=useFilter;exports.default=_default;