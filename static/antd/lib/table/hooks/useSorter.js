"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSortData=getSortData,exports.default=useFilterSorter;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_extends3=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),React=_interopRequireWildcard(require("react")),_classnames=_interopRequireDefault(require("classnames")),_CaretDownOutlined=_interopRequireDefault(require("@ant-design/icons/CaretDownOutlined")),_CaretUpOutlined=_interopRequireDefault(require("@ant-design/icons/CaretUpOutlined")),_tooltip=_interopRequireDefault(require("../../tooltip")),_util=require("../util");function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof3(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var ASCEND="ascend",DESCEND="descend";function getMultiplePriority(column){return"object"===(0,_typeof2.default)(column.sorter)&&"number"==typeof column.sorter.multiple&&column.sorter.multiple}function getSortFunction(sorter){return"function"==typeof sorter?sorter:!(!sorter||"object"!==(0,_typeof2.default)(sorter)||!sorter.compare)&&sorter.compare}function nextSortDirection(sortDirections,current){return current?sortDirections[sortDirections.indexOf(current)+1]:sortDirections[0]}function collectSortStates(columns,init,pos){var sortStates=[];function pushState(column,columnPos){sortStates.push({column:column,key:(0,_util.getColumnKey)(column,columnPos),multiplePriority:getMultiplePriority(column),sortOrder:column.sortOrder})}return(columns||[]).forEach((function(column,index){var columnPos=(0,_util.getColumnPos)(index,pos);column.children?("sortOrder"in column&&pushState(column,columnPos),sortStates=[].concat((0,_toConsumableArray2.default)(sortStates),(0,_toConsumableArray2.default)(collectSortStates(column.children,init,columnPos)))):column.sorter&&("sortOrder"in column?pushState(column,columnPos):init&&column.defaultSortOrder&&sortStates.push({column:column,key:(0,_util.getColumnKey)(column,columnPos),multiplePriority:getMultiplePriority(column),sortOrder:column.defaultSortOrder}))})),sortStates}function injectSorter(prefixCls,columns,sorterSates,triggerSorter,defaultSortDirections,tableLocale,tableShowSorterTooltip,pos){return(columns||[]).map((function(column,index){var columnPos=(0,_util.getColumnPos)(index,pos),newColumn=column;if(newColumn.sorter){var sortDirections=newColumn.sortDirections||defaultSortDirections,showSorterTooltip=void 0===newColumn.showSorterTooltip?tableShowSorterTooltip:newColumn.showSorterTooltip,columnKey=(0,_util.getColumnKey)(newColumn,columnPos),sorterState=sorterSates.find((function(_ref){return _ref.key===columnKey})),sorterOrder=sorterState?sorterState.sortOrder:null,nextSortOrder=nextSortDirection(sortDirections,sorterOrder),upNode=sortDirections.includes(ASCEND)&&React.createElement(_CaretUpOutlined.default,{className:(0,_classnames.default)("".concat(prefixCls,"-column-sorter-up"),{active:sorterOrder===ASCEND})}),downNode=sortDirections.includes(DESCEND)&&React.createElement(_CaretDownOutlined.default,{className:(0,_classnames.default)("".concat(prefixCls,"-column-sorter-down"),{active:sorterOrder===DESCEND})}),_ref2=tableLocale||{},cancelSort=_ref2.cancelSort,triggerAsc=_ref2.triggerAsc,triggerDesc=_ref2.triggerDesc,sortTip=cancelSort;nextSortOrder===DESCEND?sortTip=triggerDesc:nextSortOrder===ASCEND&&(sortTip=triggerAsc);var tooltipProps="object"===(0,_typeof2.default)(showSorterTooltip)?showSorterTooltip:{title:sortTip};newColumn=(0,_extends3.default)((0,_extends3.default)({},newColumn),{className:(0,_classnames.default)(newColumn.className,(0,_defineProperty2.default)({},"".concat(prefixCls,"-column-sort"),sorterOrder)),title:function title(renderProps){var renderSortTitle=React.createElement("div",{className:"".concat(prefixCls,"-column-sorters")},React.createElement("span",{className:"".concat(prefixCls,"-column-title")},(0,_util.renderColumnTitle)(column.title,renderProps)),React.createElement("span",{className:(0,_classnames.default)("".concat(prefixCls,"-column-sorter"),(0,_defineProperty2.default)({},"".concat(prefixCls,"-column-sorter-full"),!(!upNode||!downNode)))},React.createElement("span",{className:"".concat(prefixCls,"-column-sorter-inner")},upNode,downNode)));return showSorterTooltip?React.createElement(_tooltip.default,tooltipProps,renderSortTitle):renderSortTitle},onHeaderCell:function onHeaderCell(col){var cell=column.onHeaderCell&&column.onHeaderCell(col)||{},originOnClick=cell.onClick;return cell.onClick=function(event){triggerSorter({column:column,key:columnKey,sortOrder:nextSortOrder,multiplePriority:getMultiplePriority(column)}),originOnClick&&originOnClick(event)},cell.className=(0,_classnames.default)(cell.className,"".concat(prefixCls,"-column-has-sorters")),cell}})}return"children"in newColumn&&(newColumn=(0,_extends3.default)((0,_extends3.default)({},newColumn),{children:injectSorter(prefixCls,newColumn.children,sorterSates,triggerSorter,defaultSortDirections,tableLocale,tableShowSorterTooltip,columnPos)})),newColumn}))}function stateToInfo(sorterStates){var column=sorterStates.column;return{column:column,order:sorterStates.sortOrder,field:column.dataIndex,columnKey:column.key}}function generateSorterInfo(sorterStates){var list=sorterStates.filter((function(_ref3){return _ref3.sortOrder})).map(stateToInfo);return 0===list.length&&sorterStates.length?(0,_extends3.default)((0,_extends3.default)({},stateToInfo(sorterStates[sorterStates.length-1])),{column:void 0}):list.length<=1?list[0]||{}:list}function getSortData(data,sortStates,childrenColumnName){var innerSorterStates=sortStates.slice().sort((function(a,b){return b.multiplePriority-a.multiplePriority})),cloneData=data.slice(),runningSorters=innerSorterStates.filter((function(_ref4){var sorter=_ref4.column.sorter,sortOrder=_ref4.sortOrder;return getSortFunction(sorter)&&sortOrder}));return runningSorters.length?cloneData.sort((function(record1,record2){for(var i=0;i<runningSorters.length;i+=1){var sorterState=runningSorters[i],sorter=sorterState.column.sorter,sortOrder=sorterState.sortOrder,compareFn=getSortFunction(sorter);if(compareFn&&sortOrder){var compareResult=compareFn(record1,record2,sortOrder);if(0!==compareResult)return sortOrder===ASCEND?compareResult:-compareResult}}return 0})).map((function(record){var subRecords=record[childrenColumnName];return subRecords?(0,_extends3.default)((0,_extends3.default)({},record),(0,_defineProperty2.default)({},childrenColumnName,getSortData(subRecords,sortStates,childrenColumnName))):record})):cloneData}function useFilterSorter(_ref5){var prefixCls=_ref5.prefixCls,mergedColumns=_ref5.mergedColumns,onSorterChange=_ref5.onSorterChange,sortDirections=_ref5.sortDirections,tableLocale=_ref5.tableLocale,showSorterTooltip=_ref5.showSorterTooltip,_React$useState=React.useState(collectSortStates(mergedColumns,!0)),_React$useState2=(0,_slicedToArray2.default)(_React$useState,2),sortStates=_React$useState2[0],setSortStates=_React$useState2[1],mergedSorterStates=React.useMemo((function(){var validate=!0,collectedStates=collectSortStates(mergedColumns,!1);if(!collectedStates.length)return sortStates;var validateStates=[];function patchStates(state){validate?validateStates.push(state):validateStates.push((0,_extends3.default)((0,_extends3.default)({},state),{sortOrder:null}))}var multipleMode=null;return collectedStates.forEach((function(state){null===multipleMode?(patchStates(state),state.sortOrder&&(!1===state.multiplePriority?validate=!1:multipleMode=!0)):(multipleMode&&!1!==state.multiplePriority||(validate=!1),patchStates(state))})),validateStates}),[mergedColumns,sortStates]),columnTitleSorterProps=React.useMemo((function(){var sortColumns=mergedSorterStates.map((function(_ref6){return{column:_ref6.column,order:_ref6.sortOrder}}));return{sortColumns:sortColumns,sortColumn:sortColumns[0]&&sortColumns[0].column,sortOrder:sortColumns[0]&&sortColumns[0].order}}),[mergedSorterStates]);function triggerSorter(sortState){var newSorterStates;newSorterStates=!1!==sortState.multiplePriority&&mergedSorterStates.length&&!1!==mergedSorterStates[0].multiplePriority?[].concat((0,_toConsumableArray2.default)(mergedSorterStates.filter((function(_ref7){return _ref7.key!==sortState.key}))),[sortState]):[sortState],setSortStates(newSorterStates),onSorterChange(generateSorterInfo(newSorterStates),newSorterStates)}return[function transformColumns(innerColumns){return injectSorter(prefixCls,innerColumns,mergedSorterStates,triggerSorter,sortDirections,tableLocale,showSorterTooltip)},mergedSorterStates,columnTitleSorterProps,function getSorters(){return generateSorterInfo(mergedSorterStates)}]}